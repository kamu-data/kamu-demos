---
kind: DatasetSnapshot
version: 1
content:
  name: player-scores
  kind: derivative
  metadata:
    - kind: setTransform
      inputs:
        - name: matches
      transform:
        kind: sql
        engine: spark
        query: |
          with

          player_stats_json as (
              select
                  event_time,
                  match_id,
                  get_json_object(
                      replay_json, 
                      '$.header.body.properties.value.PlayerStats.value.array'
                  ) as ps_json 
              from matches
          ),

          player_stats_raw as (
              select
                  event_time,
                  match_id,
                  explode(from_json(ps_json, '
                      array<struct<value:struct<
                          Name:struct<value:struct<str:string>>,
                          Team:struct<value:struct<int:integer>>,
                          bBot:struct<value:struct<bool:integer>>,
                          Score:struct<value:struct<int:integer>>,
                          Goals:struct<value:struct<int:integer>>,
                          Assists:struct<value:struct<int:integer>>,
                          Shots:struct<value:struct<int:integer>>,
                          Saves:struct<value:struct<int:integer>>
                      >>>
                  ')) as stats
              from player_stats_json
          )

          select
              event_time,
              match_id,
              stats.value.name.value.str as name,
              stats.value.team.value.int as team,
              stats.value.bBot.value.bool as is_bot,
              stats.value.score.value.int as score,
              stats.value.goals.value.int as goals,
              stats.value.assists.value.int as assists,
              stats.value.shots.value.int as shots,
              stats.value.saves.value.int as saves
          from player_stats_raw
